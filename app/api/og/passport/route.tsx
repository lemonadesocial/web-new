import { ImageResponse } from 'next/og';
import { NextRequest } from 'next/server';
import { ethers } from 'ethers';

import { ListChainsDocument } from '$lib/graphql/generated/backend/graphql';
import { ERC721Contract } from '$lib/utils/crypto';
import { getClient } from '$lib/graphql/request';
import { ASSET_PREFIX } from '$lib/utils/constants';

const fetchFont = (url: string) => {
  return fetch(new URL(url)).then((res) => res.arrayBuffer());
};

const fetchChain = async () => {
  const client = getClient();
  const { data } = await client.query({ query: ListChainsDocument });
  return data?.listChains?.find((i) => i.lemonade_passport_contract_address);
};


export async function GET(req: NextRequest) {
  const searchParams = req.nextUrl.searchParams;
  const tokenId = searchParams.get('tokenId');

  if (!tokenId) {
    return new Response(`Bad Request: Token ID not provided`, { status: 400 });
  }

  const chain = await fetchChain();

  if (!chain) {
    return new Response(`Error: Chain does not support!`, { status: 400 });
  }

  let image;

  try {
    const contractAddress = chain.lemonade_passport_contract_address;

    if (!contractAddress) {
      return new Response('LemonheadPassort contract address not set', { status: 400 });
    }

    const provider = new ethers.JsonRpcProvider(chain.rpc_url);
    const contract = ERC721Contract.attach(contractAddress).connect(provider);

    const tokenUri = await contract.getFunction('tokenURI')(tokenId);
    const res = await fetch(tokenUri);
    const data = await res.json();
    image = data.image;

  } catch (err: any) {
    return new Response(err.message || 'Error: Something went wrong!', { status: 500 });
  }

  if (!image) {
    return new Response('Passport image not found', { status: 404 });
  }

  return new ImageResponse((
    <div
      style={{
        display: "flex",
        flexDirection: "column",
        justifyContent: "space-between",
        backgroundImage: `url(${ASSET_PREFIX}/assets/images/share-passport-bg.png)`,
        padding: '64px',
        width: '100%',
        height: '100%',
        borderRadius: '24px',
        borderTop: '2px solid rgba(255, 255, 255, 0.56)',
        borderRight: '2px solid rgba(255, 255, 255, 0.56)',
        borderBottom: '4px solid rgba(255, 255, 255, 0.56)',
        borderLeft: '2px solid rgba(255, 255, 255, 0.56)',
        overflow: 'hidden',
      }}
    >
      <div
        style={{
          display: "flex",
          justifyContent: "space-between",
          width: "100%",
        }}
      >
        <div style={{ display: 'flex', flexDirection: 'column', gap: '6.29px' }}>
          <UnitedStandLogoUpper />
          <UnitedStandLogoLower />
        </div>
        <LemonadeLogo />
      </div>

      <img src={image} />

      <div style={{ display: 'flex', flexDirection: 'column' }}>
        <p style={{ fontSize: 56, color: 'rgba(255, 255, 255, 0.80)', margin: 0, padding: 0 }}>Citizen</p>
        <p style={{ fontSize: 80, color: '#FFF', margin: 0, padding: 0  }}>#{tokenId}</p>
      </div>
    </div>
  ), {
    width: 1032,
    height: 1032,
    fonts: [
      {
        name: 'ClashDisplay-Bold',
        data: await fetchFont(`${ASSET_PREFIX}/assets/fonts/MultiTypePixel-DisplayBold.otf`),
        style: 'normal',
      },
    ],
  });
}

function LemonadeLogo() {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 48 48" fill="none">
      <path fill-rule="evenodd" clip-rule="evenodd" d="M28.1667 34C30.9281 34 33.1667 36.2386 33.1667 39C33.1667 41.7614 30.9281 44 28.1667 44C25.4052 44 23.1667 41.7614 23.1667 39C23.1667 36.2386 25.4052 34 28.1667 34ZM11.5 21.5C15.6421 21.5 19 24.8579 19 29C19 33.1421 15.6421 36.5 11.5 36.5C7.35786 36.5 4 33.1421 4 29C4 24.8579 7.35786 21.5 11.5 21.5ZM32.75 4C38.9632 4 44 9.0368 44 15.25C44 21.4632 38.9632 26.5 32.75 26.5C26.5368 26.5 21.5 21.4632 21.5 15.25C21.5 9.0368 26.5368 4 32.75 4Z" fill="white" />
    </svg>
  );
}

function UnitedStandLogoUpper() {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" width="126" height="16" viewBox="0 0 126 16" fill="none">
      <path d="M4.18609 15.7386C2.75161 15.7386 1.6953 15.3333 1.01718 14.5226C0.33906 13.7054 0 12.5059 0 10.9241V0.158177H3.34496V10.8845C3.34496 11.1745 3.36126 11.4546 3.39386 11.7249C3.42647 11.9885 3.50145 12.206 3.61882 12.3773C3.73619 12.5487 3.92528 12.6344 4.18609 12.6344C4.45343 12.6344 4.64578 12.552 4.76315 12.3872C4.88051 12.2159 4.95224 11.9951 4.97832 11.7249C5.01092 11.4546 5.02722 11.1745 5.02722 10.8845V0.158177H8.37219V10.9241C8.37219 12.5059 8.03312 13.7054 7.355 14.5226C6.67688 15.3333 5.62058 15.7386 4.18609 15.7386Z" fill="white" />
      <path d="M9.29195 15.5804V0.158177H12.8325L14.6126 8.52178V0.158177H17.7424V15.5804H14.3779L12.4609 7.2267V15.5804H9.29195Z" fill="white" />
      <path d="M18.7111 15.5804V0.158177H22.0365V15.5804H18.7111Z" fill="white" />
      <path d="M24.482 15.5804V3.49966H22.4378V0.158177H29.9689V3.49966H27.9248V15.5804H24.482Z" fill="white" />
      <path d="M30.5268 15.5804V0.158177H37.4123V3.51943H34.0282V6.07004H37.2754V9.34232H34.0282V12.1895H37.6373V15.5804H30.5268Z" fill="white" />
      <path d="M38.381 15.5804V0.158177H43.1246C44.3635 0.158177 45.2926 0.507484 45.912 1.2061C46.538 1.89812 46.851 2.91309 46.851 4.251V10.4199C46.851 12.0676 46.5673 13.3396 46.0001 14.2359C45.4328 15.1322 44.4352 15.5804 43.0072 15.5804H38.381ZM41.8433 12.5059H42.4399C43.0724 12.5059 43.3887 12.1961 43.3887 11.5766V4.57724C43.3887 3.99726 43.3104 3.62489 43.1539 3.46012C43.004 3.28876 42.6942 3.20308 42.2248 3.20308H41.8433V12.5059Z" fill="white" />
      <path d="M56.2411 15.7386C54.6697 15.7386 53.5352 15.3432 52.8375 14.5523C52.1463 13.7614 51.8007 12.5026 51.8007 10.7758V10.2123H55.2044V11.2503C55.2044 11.6524 55.2631 11.9687 55.3804 12.1994C55.5043 12.4235 55.7162 12.5355 56.0162 12.5355C56.3292 12.5355 56.5443 12.4531 56.6617 12.2884C56.7856 12.117 56.8475 11.8699 56.8475 11.5469C56.8475 11.1185 56.7041 10.756 56.4172 10.4594C56.1368 10.1629 55.6706 9.76083 55.0186 9.25334L53.5319 8.08679C52.8994 7.59249 52.4528 7.04546 52.192 6.44571C51.9312 5.84595 51.8007 5.11768 51.8007 4.26089C51.8007 2.92298 52.1398 1.87835 52.8179 1.12701C53.5026 0.37567 54.4904 0 55.7814 0C57.3594 0 58.4776 0.415214 59.1362 1.24564C59.8013 2.07607 60.1338 3.29535 60.1338 4.90348H56.6421V4.05328C56.6421 3.48648 56.3813 3.20308 55.8597 3.20308C55.5989 3.20308 55.4065 3.28217 55.2826 3.44035C55.1587 3.59193 55.0968 3.78965 55.0968 4.03351C55.0968 4.27737 55.1522 4.50804 55.2631 4.72553C55.3804 4.93644 55.6478 5.21324 56.0651 5.55596L58.0505 7.18716C58.7743 7.78032 59.322 8.40314 59.6937 9.05562C60.0653 9.7081 60.2512 10.555 60.2512 11.5963C60.2512 12.3213 60.1208 13.0002 59.86 13.6329C59.6057 14.2656 59.1851 14.7764 58.5983 15.1652C58.0114 15.5475 57.2257 15.7386 56.2411 15.7386Z" fill="white" />
      <path d="M62.4815 15.5804V3.49966H60.4374V0.158177H67.9685V3.49966H65.9243V15.5804H62.4815Z" fill="white" />
      <path d="M67.6852 15.5804L69.3479 0.158177H75.1869L76.8203 15.5804H73.5633L73.3384 12.7728H71.2258L71.0302 15.5804H67.6852ZM72.1452 2.92627L71.5094 9.9948H73.0156L72.3017 2.92627H72.1452Z" fill="white" />
      <path d="M77.476 15.5804V0.158177H81.0165L82.7966 8.52178V0.158177H85.9264V15.5804H82.5619L80.6449 7.2267V15.5804H77.476Z" fill="white" />
      <path d="M87.0516 15.5804V0.158177H91.7952C93.034 0.158177 93.9632 0.507484 94.5826 1.2061C95.2086 1.89812 95.5216 2.91309 95.5216 4.251V10.4199C95.5216 12.0676 95.2379 13.3396 94.6706 14.2359C94.1034 15.1322 93.1057 15.5804 91.6778 15.5804H87.0516ZM90.5139 12.5059H91.1105C91.743 12.5059 92.0592 12.1961 92.0592 11.5766V4.57724C92.0592 3.99726 91.981 3.62489 91.8245 3.46012C91.6745 3.28876 91.3648 3.20308 90.8953 3.20308H90.5139V12.5059Z" fill="white" />
      <path d="M100.618 15.7386C99.0462 15.7386 97.9117 15.3432 97.214 14.5523C96.5228 13.7614 96.1772 12.5026 96.1772 10.7758V10.2123H99.5809V11.2503C99.5809 11.6524 99.6396 11.9687 99.7569 12.1994C99.8808 12.4235 100.093 12.5355 100.393 12.5355C100.706 12.5355 100.921 12.4531 101.038 12.2884C101.162 12.117 101.224 11.8699 101.224 11.5469C101.224 11.1185 101.081 10.756 100.794 10.4594C100.513 10.1629 100.047 9.76083 99.3951 9.25334L97.9084 8.08679C97.2759 7.59249 96.8293 7.04546 96.5685 6.44571C96.3076 5.84595 96.1772 5.11768 96.1772 4.26089C96.1772 2.92298 96.5163 1.87835 97.1944 1.12701C97.8791 0.37567 98.8669 0 100.158 0C101.736 0 102.854 0.415214 103.513 1.24564C104.178 2.07607 104.51 3.29535 104.51 4.90348H101.019V4.05328C101.019 3.48648 100.758 3.20308 100.236 3.20308C99.9754 3.20308 99.783 3.28217 99.6591 3.44035C99.5352 3.59193 99.4733 3.78965 99.4733 4.03351C99.4733 4.27737 99.5287 4.50804 99.6396 4.72553C99.7569 4.93644 100.024 5.21324 100.442 5.55596L102.427 7.18716C103.151 7.78032 103.699 8.40314 104.07 9.05562C104.442 9.7081 104.628 10.555 104.628 11.5963C104.628 12.3213 104.497 13.0002 104.236 13.6329C103.982 14.2656 103.562 14.7764 102.975 15.1652C102.388 15.5475 101.602 15.7386 100.618 15.7386Z" fill="white" />
      <path d="M113.783 15.7386C112.375 15.7386 111.315 15.3102 110.604 14.4534C109.894 13.59 109.538 12.3839 109.538 10.8351V4.54758C109.538 3.05149 109.9 1.92119 110.624 1.15667C111.354 0.385556 112.407 0 113.783 0C115.165 0 116.218 0.385556 116.942 1.15667C117.666 1.92119 118.028 3.05149 118.028 4.54758V10.8351C118.028 12.3839 117.673 13.59 116.962 14.4534C116.251 15.3102 115.191 15.7386 113.783 15.7386ZM113.812 12.6344C114.138 12.6344 114.35 12.4861 114.448 12.1895C114.546 11.8863 114.595 11.5238 114.595 11.102V4.38941C114.595 4.07964 114.552 3.78965 114.468 3.51943C114.383 3.24262 114.171 3.10422 113.832 3.10422C113.499 3.10422 113.271 3.23274 113.147 3.48978C113.03 3.74022 112.971 4.04999 112.971 4.41906V11.1218C112.971 11.5766 113.023 11.9424 113.128 12.2192C113.232 12.496 113.46 12.6344 113.812 12.6344Z" fill="white" />
      <path d="M119.016 15.5804V0.158177H125.902V3.51943H122.518V6.31719H125.765V9.58947H122.518V15.5804H119.016Z" fill="white" />
    </svg>
  );
}

function UnitedStandLogoLower() {
  return (
    <svg xmlns="http://www.w3.org/2000/svg" width="126" height="26" viewBox="0 0 126 26" fill="none">
      <path d="M0 25.7389V0.292242H5.79594V20.8453H11.7565V25.7389H0Z" fill="#FDE047" />
      <path d="M12.7287 25.7389V0.292242H24.3206V5.83832H18.6234V10.0468H24.09V15.4461H18.6234V20.1439H24.6993V25.7389H12.7287Z" fill="#FDE047" />
      <path d="M25.9513 25.7389V0.292242H34.777L37.2139 15.4624L39.6343 0.292242H48.5423V25.7389H43.2403V8.20356L39.9143 25.7389H34.7111L31.1874 8.17093V25.7389H25.9513Z" fill="#FDE047" />
      <path d="M57.3521 25.9999C54.9811 25.9999 53.1973 25.2931 52.0008 23.8794C50.8043 22.4548 50.206 20.4647 50.206 17.9092V7.53476C50.206 5.06622 50.8152 3.20121 52.0337 1.93975C53.2631 0.667417 55.036 0.03125 57.3521 0.03125C59.6793 0.03125 61.4521 0.667417 62.6706 1.93975C63.889 3.20121 64.4983 5.06622 64.4983 7.53476V17.9092C64.4983 20.4647 63.9 22.4548 62.7035 23.8794C61.507 25.2931 59.7232 25.9999 57.3521 25.9999ZM57.4015 20.878C57.9504 20.878 58.3072 20.6333 58.4718 20.1439C58.6365 19.6437 58.7188 19.0456 58.7188 18.3496V7.27377C58.7188 6.76266 58.6474 6.28418 58.5047 5.83832C58.362 5.38158 58.0053 5.15321 57.4345 5.15321C56.8746 5.15321 56.4904 5.36527 56.2819 5.78938C56.0843 6.20262 55.9855 6.71373 55.9855 7.32271V18.3822C55.9855 19.1326 56.0733 19.7361 56.2489 20.1929C56.4246 20.6496 56.8088 20.878 57.4015 20.878Z" fill="#FDE047" />
      <path d="M66.162 25.7389V0.292242H72.1226L75.1193 14.0922V0.292242H80.3884V25.7389H74.7242L71.4969 11.9553V25.7389H66.162Z" fill="#FDE047" />
      <path d="M81.4922 25.7389L84.2914 0.292242H94.1214L96.8712 25.7389H91.3881L91.0094 21.1063H87.4528L87.1235 25.7389H81.4922ZM89.0006 4.8596L87.9303 16.5227H90.466L89.2641 4.8596H89.0006Z" fill="#FDE047" />
      <path d="M97.9751 25.7389V0.292242H105.961C108.047 0.292242 109.611 0.868599 110.654 2.02131C111.708 3.16315 112.234 4.83785 112.234 7.0454V17.2241C112.234 19.9427 111.757 22.0416 110.802 23.5205C109.847 24.9995 108.167 25.7389 105.763 25.7389H97.9751ZM103.804 20.6659H104.808C105.873 20.6659 106.406 20.1548 106.406 19.1326V7.5837C106.406 6.62673 106.274 6.01231 106.01 5.74045C105.758 5.4577 105.236 5.31633 104.446 5.31633H103.804V20.6659Z" fill="#FDE047" />
      <path d="M113.931 25.7389V0.292242H125.523V5.83832H119.826V10.0468H125.292V15.4461H119.826V20.1439H125.902V25.7389H113.931Z" fill="#FDE047" />
    </svg>
  )
}
